application:
  configuration:
    configuration.weblogic-user: "weblogic"
    configuration.weblogic-user-password: "123QweAsd"
    configuration.weblogic-binary-url: "https://s3.amazonaws.com/ab-atg/wls1036_generic.jar"
    configuration.jrokit-binary-url: "https://s3.amazonaws.com/ab-atg/jrockit-jdk1.6.0_45-R28.2.7-4.1.0-linux-x64.bin"
    configuration.recipe-url: "https://s3.amazonaws.com/qubell-starter-kit-artifacts/qubell-bazaar/component-oracle-weblogic-cookbooks-stable-7e08fc5.tar.gz"
    configuration.installation-dir: "/opt/middleware"
    configuration.tmp-dir: "/tmp"
    compute.imageId: "ami-bf5021d6"
    compute.login: "root"
    compute.hardwareId: "m1.xlarge"
    compute.locationId: "us-east-1"

  interfaces:
    configuration:
      "*": "bind(workflow#input.*)"
    compute:
      hardwareId: "bind(compute#configuration.hardwareId)"
      imageId:    "bind(compute#configuration.imageId)"
      login:      "bind(compute#configuration.login)"
      locationId: "bind(compute#configuration.locationId)"
    weblogic:
      "*": "bind(workflow#result.*)"

  bindings:
   - [workflow, compute]

  components:
    compute:
      type: compute.Instance
    workflow:
      type: workflow.Instance
      interfaces:
        input:
          weblogic-user: configuration(string)
          weblogic-user-password: configuration(string)
          weblogic-binary-url: configuration(string)
          jrokit-binary-url: configuration(string)
          recipe-url: configuration(string)
          installation-dir: configuration(string)
          tmp-dir: configuration(string)
        compute:
          networks:   consume-signal(map<string, map<string, string>>)
          exec:       send-command(string command, int timeout => string stdOut, string stdErr => string stdOut, string stdErr, int exitCode)
          put-file:   send-command(string filename, bytes payload)
          get-file:   send-command(string filename => bytes payload)
        result:
          wl-hosts: publish-signal(string)
          wl-admin-port: publish-signal(string)
          wl-console: publish-signal(string)
          wl-hostname: publish-signal(string)
      required: [ compute ]
      configuration:
        configuration.workflows:
          launch:
            steps:
              - get-signals:
                  action: getSignals
                  output:
                    signals: result
              - mount-storage:
                  action: execrun
                  precedingPhases: [ get-signals ]
                  parameters:
                    roles: [ compute ]
                    isSudo: true
                    command:
                      - |
                        mkdir -p /media/ephemeral0
                        mount | grep /media/ephemeral0 || mount `curl -s http://169.254.169.254/latest/meta-data/block-device-mapping/ephemeral0 | tr 'a-d' 'e-h' | sed 's#^..#/dev/xvd#'` /media/ephemeral0
                        yum -y install dejavu*

              - set-hostname:
                  action: execrun
                  phase: set-hostname
                  precedingPhases: [ mount-storage ]
                  parameters:
                    roles: [ compute ]
                    isSudo: true
                    command:
                      - curl -s http://169.254.169.254/latest/meta-data/public-hostname
                  output:
                    dns: stdout

              - install-weblogic:
                  action: chefsolo
                  precedingPhases: [set-hostname]
                  parameters:
                    roles: [ compute ]
                    recipeUrl: "{$.recipe-url}"
                    runList: ["recipe[weblogic::default]"]
                    jattrs:
                      weblogic:
                        user: "{$.weblogic-user}"
                        password: "{$.weblogic-user-password}"
                        binary_url: "{$.weblogic-binary-url}"
                        bea_home: "{$.installation-dir}"
                        tmp_path: "{$.tmp-dir}"
                      jrockit:
                        binary_url: "{$.jrokit-binary-url}"
                        bea_home: "{$.installation-dir}"
                        tmp_path: "{$.tmp-dir}"

            return:
              wl-hosts: 
                value: "{$.signals.compute.networks.public.ip}"
              wl-admin-port:
                value: "7001"
              wl-hostname:
                value: "{$.dns['*'][0]}"
              wl-console:
                value: "http://{$.dns['*'][0]}:7001/console"
